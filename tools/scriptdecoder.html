<html>

<head>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.4.2/js-yaml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.25/browser.js"></script>
    <script src="https://cdn.jsdelivr.net/babel/5.8.25/browser-polyfill.js"></script>


</head>

<body>
    <div id="output"></div>
    <script type="text/babel">
    	// Rom loading promise.
        var rom = new Promise((resolve, reject) => {
            var oReq = new XMLHttpRequest();
            oReq.open("GET", "/magicalvacation.gba", true);
            oReq.responseType = "arraybuffer";
            oReq.onreadystatechange = (oEvent) => {
                if (oReq.readyState === 4) {
                    if (oReq.status === 200) {
                        var arrayBuffer = oReq.response;
                        var byteArray = new Uint8Array(arrayBuffer);
                        resolve(byteArray);
                    } else {
                        reject("Error: " + oReq.statusText);
                    }
                }
            };
            oReq.send(null);
        });

        // Table loading promise.
        var table = new Promise((resolve, reject) => {
        	$.ajax({
    			url: "/script/table.yaml",
    			type: 'GET',
    			success: function(data){ 
        			resolve(jsyaml.safeLoad(data))
    			},
    			error: function(data) {
        			reject(data);
    			}
			});
        });

        // Wait until the table and rom are both loaded.
        Promise.all([rom, table]).then(function([rom, table]) {
        	// Generator that creates the html with tooltips.
        	let chars = (function*() {
        		var index = 6474002;
        		while (index < 6919248) {
        			var value = (rom[index] << 8) + rom[index + 1];

        			var address = index.toString(16);
        			while (address.length < 8) address = "0" + address;
        			
        			var hex = value.toString(16);
        			while (hex.length < 4) hex = "0" + hex;

        			yield `<span title="Hex Value: ${hex}, Address: ${address}">${table[value] || '?'}</span>`;
        			index += 2;
        		}
        	})();

        	// Generate and output html.
        	var html = "";
        	for (let char of chars) {
        		html += char;
        	}
        	$("#output").html(html);
            
            // Enable tooltips on all of the spans.
            $( document ).tooltip();
        });
    </script>
</body>

</html>